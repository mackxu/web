<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <title>反馈</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <style>
  /*320px布局*/
	html{font-size: 100px;}
	body{font-size: 0.14rem /*实际相当于14px*/}
	 
	/* iphone 6 */
	@media (min-device-width : 375px) and (max-device-width : 667px) and (-webkit-min-device-pixel-ratio : 2){
	    html{font-size: 117.1875px;}
	}
	/* iphone6 plus */
	@media (min-device-width : 414px) and (max-device-width : 736px) and (-webkit-min-device-pixel-ratio : 3){
	    html{font-size: 129.375px;}
	}
  body, button, textarea, h1, .dialog-fd { margin: 0; -webkit-box-sizing: border-box; box-sizing: border-box; }
  body { padding: 0; background-color: #f7f7f7; }
	.gutter { padding: 0 0.1rem; }
  .fd-content { 
  	display: block; 
  	width: 100%; height: 2rem; 
  	overflow: auto; 
  	border: 0.01rem solid #aeaeae;
  	border-radius: 0;
  	margin-bottom: 0.16rem; padding: 0.08rem 0.08rem;
  	font-size: 0.14rem; color: #b4b4b4; line-height: 1.5;
  	resize: none;
  	-webkit-appearance:none;
  }
	.hidden { display: none; }
	.header { 
		position: relative;
		background-color: #5caf19; 
		padding: 0.3rem 0 0.12rem; margin-bottom: 0.18rem; 
	}
	.header-title { color: #FFF; text-align: center; font-weight: normal; font-size: 0.2rem; }
	.btn {  
		display: block;
		text-align: center;
		-webkit-user-select: none;

	}
	.btn-fd {  
		width: 100%; line-height: 2;
		font-size: 0.18rem; font-weight: bold;
		color: #9c9c9c; border: 2px solid currentColor;
		text-decoration: none;
	}
	/* 消息提示框 */
	.dialog-fd { 
		position: absolute; bottom: 20%; left: 10%; 
		width: 80%; 
		background-color: rgba(90,172,22,0.4); color: #333;
		text-align: center; line-height: 1.4;
		padding: 0.1rem 0.2rem;
		border-radius: 6%/50%;
	}
  </style>
</head>
<body>
<div class="header header-fd">
	<h1 class="header-title">用户反馈</h1>
</div>
<form id="j-form-fd" target="myFrame" method="post" action="http://feedback.iqiyi.com/f/b/s.html" class="form-fd gutter">
	<textarea name="content" id="js-fd-content" class="fd-content" placeholder="请留下您的宝贵意见" maxlength＝"150" autofocus></textarea>
	<input type="hidden" name="player_version" value="1.1.0">
	<input type="hidden" name="fb_class" value="其他意见">
	<input type="hidden" name="entry_class" value="tv_assistant">
	<input type="hidden" name="ticket" value="" id="js-ticket-fd">

	<a target="myFrame" id="j-btn-fd" class="btn btn-fd" data-href="http://feedback.iqiyi.com/f/b/g.html" data-enable="0" href="javascript:;">提交</a>
</form>
<script type="text/javascript">
	// 保证子域名之间的跨域
	document.domain = 'iqiyi.com';
	var $$ = function(id) { 
			return document.getElementById(id.replace('#', '')); 
		}
		, fdContent = $$('#js-fd-content')
		, fdBtn = $$('#j-btn-fd')
		, btnFdColorOk = '#5caf19' 				// 按钮可发送
		, btnFdColorNot = '#9c9c9c' 			// 按钮不可用
		, fdContentMaxLen = 150						// 反馈的最多字数
		, removeNode = function(node) {
			node.parentNode.removeChild(node);
		}
		, dialogShow = function(data) {
			var dialog = document.createElement('div');
			dialog.className = 'dialog-fd';
			dialog.textContent = data;
			setTimeout(function() {
				removeNode(dialog);
			}, 3500);
			document.querySelector('body').appendChild(dialog);
		}
		, createIframeElement = function(name) {
			// 创建新的iframe等待渲染
			var frame = document.createElement('iframe');
			frame.name = name;
			frame.style.display = 'none';
			document.querySelector('body').appendChild(frame);
			return frame;
		}
		, getIframeData = function(options) {
			/**
			 * options:
			 * iframeName: 'myFrame' 默认值
			 * done: fn 
			 * before: fn
			*/
			// 创建iframe获取数据, 并插入到页面
			var frameElem = createIframeElement(options.iframeName || 'myFrame')
				, fail = options.fail
				, done = options.done
			;
			options.fail = function(res, frameElem) {
				// 显示错误提示框
				dialogShow('发送失败,请重试');
				// 删除iframe
				frameElem.parentNode.removeChild(frameElem);
			};
			options.done = function(res, frameElem) {
				if (res.code === 'A00000') {
					done && done(res, frameElem);
				}else {
					options.fail && options.fail(res, frameElem);	
				}
			};
			// 定义要在frame中调用的函数
			frameElem.contentWindow.frameElement.callback = function(res) {
				options.done(res, frameElem);
			};
			// 在获取数据前，执行
			options.before && options.before();
		}
		, setBtnState = function(enable, color) {
			fdBtn.setAttribute('data-enable', enable);
			fdBtn.style.color = color;
		}
	;
	// 添加键盘keyup事件处理函数
	fdContent.addEventListener('keyup', function(e) {
		var fdLen = fdContent.value.replace(/\s+/g, '').length;
		var btnEnable = +fdBtn.getAttribute('data-enable');
		if (fdLen === 0) {
			if (btnEnable === 0) return;
			setBtnState(0, btnFdColorNot);
		}else {
			if (btnEnable === 1) return;
			setBtnState(1, btnFdColorOk);
		}
	}, false);
	// 当用户满足提交时, 用来手动提交表单的
	fdBtn.addEventListener('click', function() {
		// 检测提交按钮是否可用
		if (!fdBtn.getAttribute('data-enable')) return false;
		// 检查文本框字数
		if(fdContent.value.replace(/\s+/g, '').length >= fdContentMaxLen) {
			dialogShow('提交失败:请简短您的描述!');
			return false;
		}
		this.href = this.getAttribute('data-href');
		// 字数限制

		getIframeData({
			done: function(res, frameElem) {
				// 获取ticket
				$$('js-ticket-fd').value = res.data;
				frameElem.parentNode.removeChild(frameElem);
				
				getIframeData({
					done: function(res, frameElem) {
						// 清空输入框，提交按钮置灰，显示成功提示框
						fdContent.value = '';
						setBtnState(0, btnFdColorNot);
						dialogShow('反馈已收到，紧急处理中…');
						// 清除创建的iframe
						frameElem.parentNode.removeChild(frameElem);
					},
					before: function() {
						// 创建完成iframe后，提交表单
						$$('#j-form-fd').submit();
					}
				});
			}
		});
	}, false);
</script>
</body>
</html>